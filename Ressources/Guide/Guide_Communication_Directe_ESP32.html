
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Communication Directe ESP32 - Projet FAJMA</title>
    
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f8f9fa;
            }
            
            .header {
                text-align: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                border-radius: 10px;
                margin-bottom: 30px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            
            .header h1 {
                margin: 0;
                font-size: 2.5em;
                font-weight: 300;
            }
            
            .content {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            h1, h2, h3, h4, h5, h6 {
                color: #2c3e50;
                margin-top: 30px;
                margin-bottom: 15px;
            }
            
            h1 {
                border-bottom: 3px solid #3498db;
                padding-bottom: 10px;
            }
            
            h2 {
                border-bottom: 2px solid #e74c3c;
                padding-bottom: 8px;
                color: #e74c3c;
            }
            
            h3 {
                color: #f39c12;
                border-left: 4px solid #f39c12;
                padding-left: 15px;
            }
            
            .toc {
                background: #ecf0f1;
                padding: 20px;
                border-radius: 8px;
                margin: 20px 0;
                border-left: 4px solid #3498db;
            }
            
            .toc ul {
                list-style-type: none;
                padding-left: 0;
            }
            
            .toc li {
                margin: 8px 0;
            }
            
            .toc a {
                color: #2980b9;
                text-decoration: none;
                font-weight: 500;
            }
            
            .toc a:hover {
                color: #3498db;
                text-decoration: underline;
            }
            
            pre {
                background: #2c3e50;
                color: #ecf0f1;
                padding: 20px;
                border-radius: 8px;
                overflow-x: auto;
                margin: 20px 0;
                border-left: 4px solid #e74c3c;
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                font-size: 14px;
                line-height: 1.4;
            }
            
            code {
                background: #ecf0f1;
                padding: 2px 6px;
                border-radius: 4px;
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                color: #e74c3c;
                font-size: 0.9em;
            }
            
            pre code {
                background: transparent;
                padding: 0;
                color: inherit;
            }
            
            blockquote {
                border-left: 4px solid #f39c12;
                margin: 20px 0;
                padding: 15px 20px;
                background: #fef9e7;
                font-style: italic;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            th, td {
                padding: 12px 15px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            
            th {
                background: #34495e;
                color: white;
                font-weight: 600;
            }
            
            tr:hover {
                background: #f8f9fa;
            }
            
            .highlight {
                background: #2c3e50;
                color: #ecf0f1;
                padding: 20px;
                border-radius: 8px;
                overflow-x: auto;
                margin: 20px 0;
            }
            
            .protocol-section {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
                border-left: 4px solid #28a745;
            }
            
            .warning {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 15px;
                margin: 20px 0;
                border-left: 4px solid #f39c12;
            }
            
            .info {
                background: #d1ecf1;
                border: 1px solid #bee5eb;
                border-radius: 8px;
                padding: 15px;
                margin: 20px 0;
                border-left: 4px solid #17a2b8;
            }
            
            .footer {
                text-align: center;
                margin-top: 40px;
                padding: 20px;
                background: #34495e;
                color: white;
                border-radius: 8px;
            }
            
            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }
                
                .header h1 {
                    font-size: 2em;
                }
                
                .content {
                    padding: 20px;
                }
                
                pre {
                    padding: 15px;
                    font-size: 12px;
                }
            }
            
            /* Syntax highlighting pour le code */
            .highlight .k { color: #66d9ef; } /* Keyword */
            .highlight .s { color: #a6e22e; } /* String */
            .highlight .c { color: #75715e; } /* Comment */
            .highlight .n { color: #f8f8f2; } /* Name */
            .highlight .o { color: #f92672; } /* Operator */
            .highlight .p { color: #f8f8f2; } /* Punctuation */
        </style>
        
</head>
<body>
    <div class="header">
        <h1>üì° Guide Communication Directe ESP32</h1>
        <p>Projet FAJMA - Solutions IoT Temps R√©el</p>
    </div>
    
    <div class="content">
        <h1 id="guide-de-communication-directe-esp32-vers-serveur">Guide de Communication Directe ESP32 vers Serveur</h1>
<h2 id="vue-densemble">Vue d'Ensemble</h2>
<p>Ce guide d√©taille les diff√©rentes m√©thodes pour envoyer des donn√©es directement depuis un ESP32 vers le serveur FAJMA, sans interm√©diaires.</p>
<h2 id="1-communication-mqtt-recommandee">1. Communication MQTT (Recommand√©e)</h2>
<h3 id="11-configuration-esp32-pour-mqtt">1.1 Configuration ESP32 pour MQTT</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;PubSubClient.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ArduinoJson.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFiClientSecure.h&gt;</span>

<span class="c1">// Configuration WiFi</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;VOTRE_WIFI&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;VOTRE_MOT_DE_PASSE&quot;</span><span class="p">;</span>

<span class="c1">// Configuration MQTT</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;votre-serveur.com&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mqtt_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8883</span><span class="p">;</span><span class="w"> </span><span class="c1">// Port s√©curis√©</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;esp32_device&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mot_de_passe_securise&quot;</span><span class="p">;</span>

<span class="c1">// Topics MQTT</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">topic_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fajma/esp32/data&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">topic_heartbeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fajma/esp32/heartbeat&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">topic_alert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fajma/esp32/alert&quot;</span><span class="p">;</span>

<span class="n">WiFiClientSecure</span><span class="w"> </span><span class="n">espClient</span><span class="p">;</span>
<span class="n">PubSubClient</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">espClient</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Connexion WiFi</span>
<span class="w">    </span><span class="n">connectWiFi</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Configuration MQTT</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">setServer</span><span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_port</span><span class="p">);</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">setCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Certificat SSL (optionnel pour d√©veloppement)</span>
<span class="w">    </span><span class="n">espClient</span><span class="p">.</span><span class="n">setInsecure</span><span class="p">();</span><span class="w"> </span><span class="c1">// √Ä remplacer par un vrai certificat en production</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">connectWiFi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Connexion WiFi&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;WiFi connect√©!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Adresse IP: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">reconnectMQTT</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Tentative de connexion MQTT...&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">clientId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32Client-&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">clientId</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">random</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">),</span><span class="w"> </span><span class="n">HEX</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">clientId</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">mqtt_user</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_password</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;connect√©&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// S&#39;abonner aux topics de commande</span>
<span class="w">            </span><span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">&quot;fajma/esp32/commands&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Envoyer un message de connexion</span>
<span class="w">            </span><span class="n">sendHeartbeat</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;√©chec, rc=&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">state</span><span class="p">());</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; nouvelle tentative dans 5 secondes&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="o">*</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Message re√ßu [&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;] &quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">message</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Traiter les commandes re√ßues</span>
<span class="w">    </span><span class="n">processCommand</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendSensorData</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">temperature</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">humidity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">heartRate</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">spO2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">reconnectMQTT</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cr√©er le JSON des donn√©es</span>
<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">200</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;temperature&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temperature</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;humidity&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">humidity</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;heart_rate&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;spo2&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spO2</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;battery_level&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getBatteryLevel</span><span class="p">();</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jsonString</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Publier les donn√©es</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">topic_data</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Donn√©es envoy√©es: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;√âchec envoi donn√©es&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendAlert</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">alertType</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">reconnectMQTT</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">150</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;alert_type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alertType</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;message&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;priority&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;high&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jsonString</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">topic_alert</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Alerte envoy√©e: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendHeartbeat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;status&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;online&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;uptime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jsonString</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">topic_heartbeat</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">reconnectMQTT</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Envoyer des donn√©es toutes les 30 secondes</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastSend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastSend</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">30000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Lire les capteurs (exemple)</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readTemperature</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">hum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHumidity</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHeartRate</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">spo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readSpO2</span><span class="p">();</span>

<span class="w">        </span><span class="n">sendSensorData</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">hum</span><span class="p">,</span><span class="w"> </span><span class="n">hr</span><span class="p">,</span><span class="w"> </span><span class="n">spo2</span><span class="p">);</span>
<span class="w">        </span><span class="n">lastSend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Heartbeat toutes les 5 minutes</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastHeartbeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastHeartbeat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">300000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sendHeartbeat</span><span class="p">();</span>
<span class="w">        </span><span class="n">lastHeartbeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="2-communication-httphttps">2. Communication HTTP/HTTPS</h2>
<h3 id="21-envoi-de-donnees-via-http-post">2.1 Envoi de donn√©es via HTTP POST</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;HTTPClient.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ArduinoJson.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendDataHTTP</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">temperature</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">humidity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">heartRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">HTTPClient</span><span class="w"> </span><span class="n">http</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Configuration de la requ√™te</span>
<span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="s">&quot;https://votre-serveur.com/api/iot/data&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bearer VOTRE_TOKEN_JWT&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;X-Device-ID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Cr√©er le payload JSON</span>
<span class="w">        </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">300</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnixTimestamp</span><span class="p">();</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="s">&quot;temperature&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temperature</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="s">&quot;humidity&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">humidity</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="s">&quot;heart_rate&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;location&quot;</span><span class="p">][</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLatitude</span><span class="p">();</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;location&quot;</span><span class="p">][</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLongitude</span><span class="p">();</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">jsonString</span><span class="p">;</span>
<span class="w">        </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Envoyer la requ√™te POST</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">httpResponseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="n">POST</span><span class="p">(</span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">httpResponseCode</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="n">getString</span><span class="p">();</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;R√©ponse HTTP: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">httpResponseCode</span><span class="p">));</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;R√©ponse: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Traiter la r√©ponse</span>
<span class="w">            </span><span class="n">processServerResponse</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Erreur HTTP: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">httpResponseCode</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;WiFi non connect√©&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Envoi de donn√©es par batch (plusieurs mesures)</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sendBatchDataHTTP</span><span class="p">(</span><span class="n">JsonArray</span><span class="w"> </span><span class="n">measurements</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HTTPClient</span><span class="w"> </span><span class="n">http</span><span class="p">;</span>

<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="s">&quot;https://votre-serveur.com/api/iot/batch&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bearer VOTRE_TOKEN_JWT&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">1000</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;batch_timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnixTimestamp</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;measurements&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measurements</span><span class="p">;</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jsonString</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">httpResponseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="n">POST</span><span class="p">(</span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">httpResponseCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Batch envoy√© avec succ√®s&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Erreur envoi batch: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">httpResponseCode</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="3-communication-websocket">3. Communication WebSocket</h2>
<h3 id="31-websocket-en-temps-reel">3.1 WebSocket en temps r√©el</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WebSocketsClient.h&gt;</span>

<span class="n">WebSocketsClient</span><span class="w"> </span><span class="n">webSocket</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">wsConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setupWebSocket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Configuration WebSocket</span>
<span class="w">    </span><span class="n">webSocket</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="s">&quot;votre-serveur.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">8000</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/ws/iot/ESP32_001/&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// √âv√©nements WebSocket</span>
<span class="w">    </span><span class="n">webSocket</span><span class="p">.</span><span class="n">onEvent</span><span class="p">(</span><span class="n">webSocketEvent</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Authentification</span>
<span class="w">    </span><span class="n">webSocket</span><span class="p">.</span><span class="n">setAuthorization</span><span class="p">(</span><span class="s">&quot;Bearer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VOTRE_TOKEN_JWT&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Reconnexion automatique</span>
<span class="w">    </span><span class="n">webSocket</span><span class="p">.</span><span class="n">setReconnectInterval</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">webSocketEvent</span><span class="p">(</span><span class="n">WStype_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">WStype_DISCONNECTED</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;WebSocket D√©connect√©&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">wsConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">WStype_CONNECTED</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WebSocket Connect√© √†: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span>
<span class="w">            </span><span class="n">wsConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Envoyer un message de connexion</span>
<span class="w">            </span><span class="n">sendWSMessage</span><span class="p">(</span><span class="s">&quot;connection&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ESP32_001 connect√©&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">WStype_TEXT</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Message re√ßu: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span>
<span class="w">            </span><span class="n">processWSMessage</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">WStype_ERROR</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Erreur WebSocket: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendWSMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wsConnected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">200</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">;</span>
<span class="w">        </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>

<span class="w">        </span><span class="n">webSocket</span><span class="p">.</span><span class="n">sendTXT</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendRealtimeData</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">heartRate</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">spO2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wsConnected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">150</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;realtime_data&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;heart_rate&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartRate</span><span class="p">;</span>
<span class="w">        </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;spo2&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spO2</span><span class="p">;</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">;</span>
<span class="w">        </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>

<span class="w">        </span><span class="n">webSocket</span><span class="p">.</span><span class="n">sendTXT</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">webSocket</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Envoyer des donn√©es en temps r√©el</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastRealtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastRealtime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Chaque seconde</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHeartRate</span><span class="p">();</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">spo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readSpO2</span><span class="p">();</span>

<span class="w">        </span><span class="n">sendRealtimeData</span><span class="p">(</span><span class="n">hr</span><span class="p">,</span><span class="w"> </span><span class="n">spo2</span><span class="p">);</span>
<span class="w">        </span><span class="n">lastRealtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4-communication-lorawan-longue-distance">4. Communication LoRaWAN (Longue Distance)</h2>
<h3 id="41-configuration-lorawan">4.1 Configuration LoRaWAN</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;lmic.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;hal/hal.h&gt;</span>

<span class="c1">// Configuration LoRaWAN</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u1_t</span><span class="w"> </span><span class="n">PROGMEM</span><span class="w"> </span><span class="n">APPEUI</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* Votre App EUI */</span><span class="w"> </span><span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u1_t</span><span class="w"> </span><span class="n">PROGMEM</span><span class="w"> </span><span class="n">DEVEUI</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* Votre Device EUI */</span><span class="w"> </span><span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u1_t</span><span class="w"> </span><span class="n">PROGMEM</span><span class="w"> </span><span class="n">APPKEY</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* Votre App Key */</span><span class="w"> </span><span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">os_getArtEui</span><span class="w"> </span><span class="p">(</span><span class="n">u1_t</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">memcpy_P</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">APPEUI</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">os_getDevEui</span><span class="w"> </span><span class="p">(</span><span class="n">u1_t</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">memcpy_P</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">DEVEUI</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">os_getDevKey</span><span class="w"> </span><span class="p">(</span><span class="n">u1_t</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">memcpy_P</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">APPKEY</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);}</span>

<span class="k">static</span><span class="w"> </span><span class="n">osjob_t</span><span class="w"> </span><span class="n">sendjob</span><span class="p">;</span>

<span class="c1">// Mapping des pins</span>
<span class="k">const</span><span class="w"> </span><span class="n">lmic_pinmap</span><span class="w"> </span><span class="n">lmic_pins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">nss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">rxtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LMIC_UNUSED_PIN</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendLoRaData</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">temperature</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">heartRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Pr√©parer les donn√©es (format compact)</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">payload</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Encoder la temp√©rature (2 bytes)</span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">temp_encoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int16_t</span><span class="p">)(</span><span class="n">temperature</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_encoded</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_encoded</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Encoder le rythme cardiaque (2 bytes)</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">hr_encoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">heartRate</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hr_encoded</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hr_encoded</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Timestamp (4 bytes)</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Envoyer via LoRaWAN</span>
<span class="w">    </span><span class="n">LMIC_setTxData2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Donn√©es LoRaWAN envoy√©es&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">onEvent</span><span class="w"> </span><span class="p">(</span><span class="n">ev_t</span><span class="w"> </span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">EV_JOINED</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;LoRaWAN rejoint le r√©seau&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">EV_TXCOMPLETE</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Transmission LoRaWAN termin√©e&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Programmer le prochain envoi</span>
<span class="w">            </span><span class="n">os_setTimedCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sendjob</span><span class="p">,</span><span class="w"> </span><span class="n">os_getTime</span><span class="p">()</span><span class="o">+</span><span class="n">sec2osticks</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span><span class="w"> </span><span class="n">do_send</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">do_send</span><span class="p">(</span><span class="n">osjob_t</span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LMIC</span><span class="p">.</span><span class="n">opmode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">OP_TXRXPEND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;OP_TXRXPEND, pas d&#39;envoi&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Lire les capteurs et envoyer</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readTemperature</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHeartRate</span><span class="p">();</span>

<span class="w">        </span><span class="n">sendLoRaData</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">hr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="5-gestion-des-erreurs-et-reconnexion">5. Gestion des Erreurs et Reconnexion</h2>
<h3 id="51-systeme-de-retry-et-buffer">5.1 Syst√®me de retry et buffer</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;EEPROM.h&gt;</span>

<span class="c1">// Structure pour stocker les donn√©es en cas d&#39;√©chec</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">DataBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">temperature</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">humidity</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">heartRate</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">spO2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">sent</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define BUFFER_SIZE 50</span>
<span class="cp">#define EEPROM_SIZE 4096</span>

<span class="n">DataBuffer</span><span class="w"> </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">bufferIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">saveToBuffer</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">hum</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hr</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">spo2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">bufferIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">hum</span><span class="p">,</span><span class="w"> </span><span class="n">hr</span><span class="p">,</span><span class="w"> </span><span class="n">spo2</span><span class="p">,</span><span class="w"> </span><span class="n">millis</span><span class="p">(),</span><span class="w"> </span><span class="nb">false</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">bufferIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bufferIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sauvegarder en EEPROM</span>
<span class="w">    </span><span class="n">saveBufferToEEPROM</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendBufferedData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sent</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Essayer MQTT d&#39;abord</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sendSensorDataMQTT</span><span class="p">(</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temperature</span><span class="p">,</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">humidity</span><span class="p">,</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">heartRate</span><span class="p">,</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spO2</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Si MQTT √©choue, essayer HTTP</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sendDataHTTP</span><span class="p">(</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temperature</span><span class="p">,</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">humidity</span><span class="p">,</span>
<span class="w">                    </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">heartRate</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">dataBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Donn√©es buffer envoy√©es: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">saveBufferToEEPROM</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">EEPROM</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">EEPROM_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">EEPROM</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">dataBuffer</span><span class="p">);</span>
<span class="w">    </span><span class="n">EEPROM</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loadBufferFromEEPROM</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">EEPROM</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">EEPROM_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">EEPROM</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">dataBuffer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="6-securite-et-authentification">6. S√©curit√© et Authentification</h2>
<h3 id="61-authentification-jwt">6.1 Authentification JWT</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mbedtls/md.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;base64.h&gt;</span>

<span class="n">String</span><span class="w"> </span><span class="n">deviceToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="n">String</span><span class="w"> </span><span class="nf">generateJWT</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Header JWT</span>
<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="w"> </span><span class="n">header</span><span class="p">;</span>
<span class="w">    </span><span class="n">header</span><span class="p">[</span><span class="s">&quot;alg&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;HS256&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">header</span><span class="p">[</span><span class="s">&quot;typ&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;JWT&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">headerStr</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">headerStr</span><span class="p">);</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">encodedHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base64</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">headerStr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Payload JWT</span>
<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">200</span><span class="o">&gt;</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="s">&quot;iat&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnixTimestamp</span><span class="p">();</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="s">&quot;exp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnixTimestamp</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3600</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1 heure</span>
<span class="w">    </span><span class="n">payload</span><span class="p">[</span><span class="s">&quot;iss&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fajma-iot&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">payloadStr</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">payloadStr</span><span class="p">);</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">encodedPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base64</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">payloadStr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Signature</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encodedHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">encodedPayload</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hmacSHA256</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VOTRE_SECRET_KEY&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">encodedSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base64</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">encodedSignature</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">refreshToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">300000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Renouveler 5 min avant expiration</span>
<span class="w">        </span><span class="n">deviceToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateJWT</span><span class="p">();</span>
<span class="w">        </span><span class="n">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3600000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1 heure</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Token JWT renouvel√©&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="7-optimisation-de-la-consommation">7. Optimisation de la Consommation</h2>
<h3 id="71-mode-deep-sleep">7.1 Mode Deep Sleep</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;esp_sleep.h&gt;</span>

<span class="cp">#define SLEEP_DURATION 30 </span><span class="c1">// secondes</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">enterDeepSleep</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Entr√©e en mode Deep Sleep pour &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">SLEEP_DURATION</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; secondes&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Sauvegarder l&#39;√©tat si n√©cessaire</span>
<span class="w">    </span><span class="n">saveStateToRTC</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Configurer le r√©veil</span>
<span class="w">    </span><span class="n">esp_sleep_enable_timer_wakeup</span><span class="p">(</span><span class="n">SLEEP_DURATION</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Entrer en Deep Sleep</span>
<span class="w">    </span><span class="n">esp_deep_sleep_start</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// V√©rifier la cause du r√©veil</span>
<span class="w">    </span><span class="n">esp_sleep_wakeup_cause_t</span><span class="w"> </span><span class="n">wakeup_reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp_sleep_get_wakeup_cause</span><span class="p">();</span>

<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="n">wakeup_reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ESP_SLEEP_WAKEUP_TIMER</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;R√©veil par timer&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ESP_SLEEP_WAKEUP_EXT0</span><span class="p">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;R√©veil par signal externe&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Premier d√©marrage&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Configuration normale...</span>
<span class="w">    </span><span class="n">connectWiFi</span><span class="p">();</span>
<span class="w">    </span><span class="n">setupMQTT</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Lire les capteurs</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readTemperature</span><span class="p">();</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHeartRate</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Envoyer les donn√©es</span>
<span class="w">    </span><span class="n">sendSensorData</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">hr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Attendre la confirmation d&#39;envoi</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Entrer en Deep Sleep</span>
<span class="w">    </span><span class="n">enterDeepSleep</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="8-exemple-dintegration-complete">8. Exemple d'Int√©gration Compl√®te</h2>
<h3 id="81-code-principal-avec-tous-les-protocoles">8.1 Code principal avec tous les protocoles</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;PubSubClient.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;HTTPClient.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WebSocketsClient.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ArduinoJson.h&gt;</span>

<span class="c1">// Configuration</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;VOTRE_WIFI&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;VOTRE_MOT_DE_PASSE&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">server_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;votre-serveur.com&quot;</span><span class="p">;</span>

<span class="c1">// Clients de communication</span>
<span class="n">WiFiClientSecure</span><span class="w"> </span><span class="n">espClient</span><span class="p">;</span>
<span class="n">PubSubClient</span><span class="w"> </span><span class="nf">mqttClient</span><span class="p">(</span><span class="n">espClient</span><span class="p">);</span>
<span class="n">WebSocketsClient</span><span class="w"> </span><span class="n">webSocket</span><span class="p">;</span>
<span class="n">HTTPClient</span><span class="w"> </span><span class="n">http</span><span class="p">;</span>

<span class="c1">// Variables d&#39;√©tat</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">mqttConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">wsConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">wifiConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Initialisation</span>
<span class="w">    </span><span class="n">connectWiFi</span><span class="p">();</span>
<span class="w">    </span><span class="n">setupMQTT</span><span class="p">();</span>
<span class="w">    </span><span class="n">setupWebSocket</span><span class="p">();</span>

<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;ESP32 pr√™t pour communication directe&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Maintenir les connexions</span>
<span class="w">    </span><span class="n">maintainConnections</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Lire les capteurs</span>
<span class="w">    </span><span class="n">SensorData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readAllSensors</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Envoyer via le meilleur protocole disponible</span>
<span class="w">    </span><span class="n">sendDataOptimal</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Attendre 10 secondes</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendDataOptimal</span><span class="p">(</span><span class="n">SensorData</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Priorit√© 1: WebSocket pour temps r√©el</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wsConnected</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">isRealtime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sendViaWebSocket</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Priorit√© 2: MQTT pour fiabilit√©</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mqttConnected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sendViaMQTT</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Priorit√© 3: HTTP en dernier recours</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">wifiConnected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sendViaHTTP</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Si tout √©choue, sauvegarder en buffer</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">saveToBuffer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Donn√©es sauvegard√©es en buffer&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">SensorData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">temperature</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">humidity</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">heartRate</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">spO2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">batteryLevel</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isRealtime</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">SensorData</span><span class="w"> </span><span class="nf">readAllSensors</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SensorData</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readTemperature</span><span class="p">();</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">humidity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHumidity</span><span class="p">();</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">heartRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readHeartRate</span><span class="p">();</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">spO2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readSpO2</span><span class="p">();</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">batteryLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getBatteryLevel</span><span class="p">();</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">isRealtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">heartRate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Temps r√©el si rythme cardiaque d√©tect√©</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="9-configuration-serveur-django">9. Configuration Serveur Django</h2>
<h3 id="91-reception-des-donnees-esp32">9.1 R√©ception des donn√©es ESP32</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># views.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="nd">@csrf_exempt</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">receive_iot_data</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device_id&#39;</span><span class="p">)</span>

        <span class="c1"># Valider les donn√©es</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">device_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;device_id requis&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

        <span class="c1"># Sauvegarder en base de donn√©es</span>
        <span class="n">sensor_data</span> <span class="o">=</span> <span class="n">SensorData</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">),</span>
            <span class="n">humidity</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;humidity&#39;</span><span class="p">),</span>
            <span class="n">heart_rate</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;heart_rate&#39;</span><span class="p">),</span>
            <span class="n">spo2</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spo2&#39;</span><span class="p">),</span>
            <span class="n">battery_level</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;battery_level&#39;</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Envoyer via WebSocket aux clients connect√©s</span>
        <span class="n">channel_layer</span> <span class="o">=</span> <span class="n">get_channel_layer</span><span class="p">()</span>
        <span class="n">async_to_sync</span><span class="p">(</span><span class="n">channel_layer</span><span class="o">.</span><span class="n">group_send</span><span class="p">)(</span>
            <span class="sa">f</span><span class="s2">&quot;patient_</span><span class="si">{</span><span class="n">device_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sensor_data&#39;</span><span class="p">,</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="s1">&#39;heart_rate&#39;</span><span class="p">:</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">heart_rate</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="nd">@csrf_exempt</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">receive_batch_data</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device_id&#39;</span><span class="p">)</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">created_records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">measurement</span> <span class="ow">in</span> <span class="n">measurements</span><span class="p">:</span>
            <span class="n">sensor_data</span> <span class="o">=</span> <span class="n">SensorData</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">,</span>
                <span class="o">**</span><span class="n">measurement</span>
            <span class="p">)</span>
            <span class="n">created_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sensor_data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;created_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">created_records</span><span class="p">),</span>
            <span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">created_records</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</code></pre></div>

<h2 id="10-surveillance-et-debugging">10. Surveillance et Debugging</h2>
<h3 id="101-logs-et-monitoring">10.1 Logs et monitoring</h3>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">logConnectionStatus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;=== √âtat des Connexions ===&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;WiFi: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Connect√©&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;D√©connect√©&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;MQTT: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">mqttClient</span><span class="p">.</span><span class="n">connected</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Connect√©&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;D√©connect√©&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;WebSocket: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">wsConnected</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Connect√©&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;D√©connect√©&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Signal WiFi: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">RSSI</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; dBm&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;M√©moire libre: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">ESP</span><span class="p">.</span><span class="n">getFreeHeap</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; bytes&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Uptime: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; secondes&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;==============================&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sendDiagnostics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">300</span><span class="o">&gt;</span><span class="w"> </span><span class="n">doc</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;device_id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ESP32_001&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;diagnostics&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;wifi_rssi&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WiFi</span><span class="p">.</span><span class="n">RSSI</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;free_heap&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP</span><span class="p">.</span><span class="n">getFreeHeap</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;uptime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;reset_reason&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp_reset_reason</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;chip_revision&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP</span><span class="p">.</span><span class="n">getChipRevision</span><span class="p">();</span>
<span class="w">    </span><span class="n">doc</span><span class="p">[</span><span class="s">&quot;sdk_version&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP</span><span class="p">.</span><span class="n">getSdkVersion</span><span class="p">();</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jsonString</span><span class="p">;</span>
<span class="w">    </span><span class="n">serializeJson</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Envoyer via le protocole disponible</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mqttClient</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mqttClient</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">&quot;fajma/esp32/diagnostics&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">jsonString</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Ce guide couvre toutes les m√©thodes principales pour envoyer des donn√©es directement depuis ESP32 vers votre serveur FAJMA, avec des exemples pratiques et des consid√©rations de s√©curit√© et d'optimisation.</p>
    </div>
    
    <div class="footer">
        <p>¬© 2024 FENKU-IT - Guide ESP32 Communication Directe</p>
        <p>G√©n√©r√© automatiquement le convert_esp32_guide_to_html.py</p>
    </div>
    
    
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Smooth scrolling pour les liens internes
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const target = document.querySelector(this.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });
                
                // Bouton retour en haut
                const backToTop = document.createElement('button');
                backToTop.innerHTML = '‚Üë';
                backToTop.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #3498db;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 50px;
                    height: 50px;
                    font-size: 20px;
                    cursor: pointer;
                    display: none;
                    z-index: 1000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                
                backToTop.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                document.body.appendChild(backToTop);
                
                // Afficher/masquer le bouton selon le scroll
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) {
                        backToTop.style.display = 'block';
                    } else {
                        backToTop.style.display = 'none';
                    }
                });
            });
        </script>
        
</body>
</html>
        